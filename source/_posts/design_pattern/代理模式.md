---
title: è®¾è®¡æ¨¡å¼ä¹‹ä»£ç†æ¨¡å¼
published: false
layout: post
date: 2025-12-09 18:40:00
permalink: /design_pattern/proxy_pattern.html
categories: [è®¾è®¡æ¨¡å¼]

---



## æ¦‚å¿µ

**ä»£ç†æ¨¡å¼**æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œå®ƒä¸ºä¸€ä¸ªå¯¹è±¡æä¾›ä¸€ä¸ªæ›¿èº«æˆ–å ä½ç¬¦ï¼Œä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚ä»£ç†å¯¹è±¡åœ¨å®¢æˆ·ç«¯å’Œç›®æ ‡å¯¹è±¡ä¹‹é—´èµ·åˆ°ä¸­ä»‹çš„ä½œç”¨ã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼š**æ§åˆ¶è®¿é—®**ï¼Œè€Œä¸æ˜¯åŠŸèƒ½å¢å¼ºã€‚ä»£ç†æ¨¡å¼ä¸»è¦ç”¨äºæ§åˆ¶å¯¹åŸå§‹å¯¹è±¡çš„è®¿é—®ï¼Œå¯ä»¥ç”¨äºå»¶è¿ŸåŠ è½½ã€è®¿é—®æ§åˆ¶ã€æ—¥å¿—è®°å½•ã€ç¼“å­˜ç­‰ã€‚

**ä¸‰ç§ä¸»è¦ç±»å‹**ï¼š

1. **é™æ€ä»£ç†**ï¼šåœ¨ç¼–è¯‘æ—¶ç¡®å®šä»£ç†å…³ç³»
2. **åŠ¨æ€ä»£ç†**ï¼šåœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä»£ç†ç±»ï¼Œä¸»è¦ä½¿ç”¨ `InvocationHandler` å®ç°ä»£ç†ï¼Œè¦æ±‚ä»£ç†å¯¹è±¡éœ€è¦å®šä¹‰æ¥å£å’Œå®ç°ç±»
3. **CGLIBä»£ç†**ï¼šåŸºäºå­ç±»çš„åŠ¨æ€ä»£ç†



## é€‚ç”¨åœºæ™¯

**âœ… é€‚ç”¨åœºæ™¯ï¼š**

1. **è¿œç¨‹ä»£ç†**ï¼šä¸ºä¸€ä¸ªå¯¹è±¡åœ¨ä¸åŒåœ°å€ç©ºé—´æä¾›å±€éƒ¨ä»£è¡¨
2. **è™šæ‹Ÿä»£ç†**ï¼šåˆ›å»ºå¼€é”€å¤§çš„å¯¹è±¡çš„ä»£è¡¨ï¼Œå»¶è¿ŸçœŸå®å¯¹è±¡çš„åˆ›å»º
3. **ä¿æŠ¤ä»£ç†**ï¼šæ§åˆ¶å¯¹åŸå§‹å¯¹è±¡çš„è®¿é—®æƒé™
4. **æ™ºèƒ½å¼•ç”¨**ï¼šåœ¨è®¿é—®å¯¹è±¡æ—¶æ‰§è¡Œé¢å¤–æ“ä½œï¼ˆå¦‚å¼•ç”¨è®¡æ•°ã€æ‡’åŠ è½½ï¼‰
5. **ç¼“å­˜ä»£ç†**ï¼šä¸ºå¼€é”€å¤§çš„æ“ä½œæä¾›ä¸´æ—¶å­˜å‚¨
6. **æ—¥å¿—è®°å½•**ï¼šè®°å½•å¯¹æ–¹æ³•çš„è°ƒç”¨ä¿¡æ¯

**âŒ ä¸é€‚ç”¨åœºæ™¯ï¼š**

- å¯¹è±¡æœ¬èº«è¶³å¤Ÿç®€å•ï¼Œä¸éœ€è¦ä»£ç†
- è®¿é—®æ§åˆ¶é€»è¾‘è¿‡äºå¤æ‚
- ä»£ç†å¯¼è‡´æ€§èƒ½ä¸¥é‡ä¸‹é™



**ğŸ¯ å…¸å‹ä¾‹å­ï¼š**

- **Spring AOP**ï¼šæ–¹æ³•æ‹¦æˆªå’Œå¢å¼º
- **RMIï¼ˆè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼‰**ï¼šè¿œç¨‹å¯¹è±¡ä»£ç†
- **MyBatis**ï¼šMapperæ¥å£çš„ä»£ç†å®ç°
- **Hibernate**ï¼šå»¶è¿ŸåŠ è½½ä»£ç†
- **JavaåŠ¨æ€ä»£ç†**ï¼š`InvocationHandler`
- **é˜²ç«å¢™ä»£ç†**ï¼šæ§åˆ¶ç½‘ç»œè®¿é—®



**ä¸è£…é¥°å™¨æ¨¡å¼çš„æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”**

| ç»´åº¦         | **ä»£ç†æ¨¡å¼**                   | **è£…é¥°å™¨æ¨¡å¼**                 |
| :----------- | :----------------------------- | :----------------------------- |
| **æ ¸å¿ƒç›®çš„** | æ§åˆ¶è®¿é—®                       | å¢å¼ºåŠŸèƒ½                       |
| **å…³æ³¨ç‚¹**   | è°å¯ä»¥è®¿é—®ã€ä½•æ—¶è®¿é—®ã€å¦‚ä½•è®¿é—® | å¢åŠ ä»€ä¹ˆæ–°åŠŸèƒ½ã€å¦‚ä½•ç»„åˆåŠŸèƒ½   |
| **è®¾è®¡æ„å›¾** | ä¸ºå¯¹è±¡æä¾›ä¸€ä¸ªæ›¿ä»£å“æˆ–å ä½ç¬¦   | åŠ¨æ€åœ°ç»™å¯¹è±¡æ·»åŠ é¢å¤–çš„èŒè´£     |
| **æ§åˆ¶å…³ç³»** | ä»£ç†æ§åˆ¶å¯¹çœŸå®å¯¹è±¡çš„è®¿é—®       | è£…é¥°å™¨å’Œè¢«è£…é¥°å¯¹è±¡å¹³ç­‰         |
| **åˆ›å»ºæ—¶æœº** | ä»£ç†é€šå¸¸æ§åˆ¶çœŸå®å¯¹è±¡çš„åˆ›å»º     | å®¢æˆ·ç«¯æ§åˆ¶è£…é¥°é“¾çš„åˆ›å»º         |
| **é€æ˜åº¦**   | å¯èƒ½ä¸é€æ˜ï¼ˆå®¢æˆ·ç«¯çŸ¥é“æ˜¯ä»£ç†ï¼‰ | å®Œå…¨é€æ˜ï¼ˆå®¢æˆ·ç«¯ä¸çŸ¥é“è¢«è£…é¥°ï¼‰ |
| **å…¸å‹ä¾‹å­** | é˜²ç«å¢™ã€è¿œç¨‹ä»£ç†ã€ä¿æŠ¤ä»£ç†     | Java I/Oæµã€å’–å•¡åŠ è°ƒæ–™         |



## ç±»å›¾

![image-20251209191751843](https://raw.githubusercontent.com/duwei0227/picbed/main/blogs/image-20251209191751843.png)

**ç±»å›¾è¯´æ˜ï¼š**

- **`Client`**ï¼šé€šè¿‡Subjectæ¥å£ä½¿ç”¨å¯¹è±¡
- **`Subject`**ï¼šå®šä¹‰äº†RealSubjectå’ŒProxyçš„å…±åŒæ¥å£
- **`RealSubject`**ï¼šçœŸå®å¯¹è±¡ï¼Œå®Œæˆå…·ä½“çš„ä¸šåŠ¡é€»è¾‘
- **`Proxy`**ï¼šä»£ç†å¯¹è±¡ï¼Œæ§åˆ¶å¯¹RealSubjectçš„è®¿é—®



## ç¤ºä¾‹

### 1. é™æ€ä»£ç† - æ–‡ä»¶ä¸‹è½½ç³»ç»Ÿ

#### 1.1 ä¸»é¢˜æ¥å£

```java
package cn.probiecoder.proxy;

// ä¸‹è½½æ¥å£
public interface Downloader {
    void download(String url);
    void download(String url, String destPath);
    long getFileSize(String url);
}
```



#### 1.2. çœŸå®ä¸»é¢˜

```java
package cn.probiecoder.proxy;

// çœŸå®ä¸‹è½½å™¨ - å®ç°å…·ä½“çš„ä¸‹è½½é€»è¾‘
public class RealDownloader implements Downloader {
    
    public RealDownloader() {
        System.out.println("åˆ›å»ºçœŸå®ä¸‹è½½å™¨ï¼ˆå¼€é”€è¾ƒå¤§ï¼‰");
        // æ¨¡æ‹Ÿåˆå§‹åŒ–å¼€é”€
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
    
    @Override
    public void download(String url) {
        download(url, "./downloads/");
    }
    
    @Override
    public void download(String url, String destPath) {
        System.out.println("å¼€å§‹ä¸‹è½½: " + url);
        System.out.println("ä¿å­˜åˆ°: " + destPath);
        
        // æ¨¡æ‹Ÿä¸‹è½½è¿‡ç¨‹
        try {
            Thread.sleep(2000);
            System.out.println("ä¸‹è½½å®Œæˆ: " + url);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
    
    @Override
    public long getFileSize(String url) {
        System.out.println("è·å–æ–‡ä»¶å¤§å°: " + url);
        // æ¨¡æ‹Ÿè·å–æ–‡ä»¶å¤§å°ï¼ˆå¯èƒ½éœ€è¦ç½‘ç»œè¯·æ±‚ï¼‰
        try {
            Thread.sleep(500);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        return 1024 * 1024 * 10; // 10MB
    }
}

```



#### 1.3. ä»£ç†ç±»

```java
package cn.probiecoder.proxy;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;

// ä¸‹è½½ä»£ç† - æ·»åŠ é¢å¤–åŠŸèƒ½
public class DownloadProxy implements Downloader {
    private RealDownloader realDownloader;
    private Map<String, Long> sizeCache = new HashMap<>();
    private Map<String, Integer> downloadCount = new HashMap<>();
    
    @Override
    public void download(String url) {
        // å»¶è¿Ÿåˆå§‹åŒ–çœŸå®ä¸‹è½½å™¨
        if (realDownloader == null) {
            System.out.println("[ä»£ç†] ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œåˆ›å»ºçœŸå®ä¸‹è½½å™¨...");
            realDownloader = new RealDownloader();
        }
        
        // è®¿é—®æ§åˆ¶ï¼šæ£€æŸ¥ä¸‹è½½æƒé™
        if (!checkAccess(url)) {
            System.out.println("[ä»£ç†] æ— æƒä¸‹è½½æ­¤æ–‡ä»¶: " + url);
            return;
        }
        
        // è®°å½•æ—¥å¿—
        logDownload(url);
        
        // ç»Ÿè®¡ä¸‹è½½æ¬¡æ•°
        downloadCount.put(url, downloadCount.getOrDefault(url, 0) + 1);
        System.out.println("[ä»£ç†] æ–‡ä»¶ " + url + " å·²è¢«ä¸‹è½½ " + downloadCount.get(url) + " æ¬¡");
        
        // è°ƒç”¨çœŸå®ä¸‹è½½å™¨
        long startTime = System.currentTimeMillis();
        realDownloader.download(url);
        long endTime = System.currentTimeMillis();
        
        System.out.println("[ä»£ç†] ä¸‹è½½è€—æ—¶: " + (endTime - startTime) + "ms");
    }
    
    @Override
    public void download(String url, String destPath) {
        if (realDownloader == null) {
            realDownloader = new RealDownloader();
        }
        
        if (!checkAccess(url)) {
            System.out.println("[ä»£ç†] æ— æƒä¸‹è½½æ­¤æ–‡ä»¶: " + url);
            return;
        }
        
        logDownload(url);
        
        long startTime = System.currentTimeMillis();
        realDownloader.download(url, destPath);
        long endTime = System.currentTimeMillis();
        
        System.out.println("[ä»£ç†] ä¸‹è½½è€—æ—¶: " + (endTime - startTime) + "ms");
    }
    
    @Override
    public long getFileSize(String url) {
        // ä½¿ç”¨ç¼“å­˜
        if (sizeCache.containsKey(url)) {
            System.out.println("[ä»£ç†] ä»ç¼“å­˜è·å–æ–‡ä»¶å¤§å°: " + url);
            return sizeCache.get(url);
        }
        
        if (realDownloader == null) {
            realDownloader = new RealDownloader();
        }
        
        long size = realDownloader.getFileSize(url);
        sizeCache.put(url, size);
        
        System.out.println("[ä»£ç†] å·²ç¼“å­˜æ–‡ä»¶å¤§å°: " + url + " = " + size + " bytes");
        return size;
    }
    
    private boolean checkAccess(String url) {
        // ç®€å•çš„è®¿é—®æ§åˆ¶é€»è¾‘
        if (url.contains("restricted")) {
            return false;
        }
        return true;
    }
    
    private void logDownload(String url) {
        System.out.println("[ä»£ç†] ä¸‹è½½æ—¥å¿—: " + 
                         LocalDateTime.now() + " - " + url + " - " + 
                         Thread.currentThread().getName());
    }
    
    // ä»£ç†ç‰¹æœ‰æ–¹æ³•
    public void clearCache() {
        sizeCache.clear();
        System.out.println("[ä»£ç†] ç¼“å­˜å·²æ¸…é™¤");
    }
    
    public Map<String, Integer> getDownloadStatistics() {
        return new HashMap<>(downloadCount);
    }
}
```



#### 1.4. å®¢æˆ·ç«¯ä½¿ç”¨

```java
package cn.probiecoder.proxy;

import java.util.Map;

// å®¢æˆ·ç«¯
public class DownloadClient {
    public static void main(String[] args) {
        System.out.println("=== é™æ€ä»£ç†æ¨¡å¼ - æ–‡ä»¶ä¸‹è½½ç³»ç»Ÿ ===\n");
        
        // ä½¿ç”¨ä»£ç†ä¸‹è½½æ–‡ä»¶
        Downloader downloader = new DownloadProxy();
        
        // 1. ç¬¬ä¸€æ¬¡ä¸‹è½½ï¼ˆä¼šåˆ›å»ºçœŸå®ä¸‹è½½å™¨ï¼‰
        System.out.println("1. ç¬¬ä¸€æ¬¡ä¸‹è½½ï¼š");
        downloader.download("https://example.com/file1.zip");
        
        System.out.println("\n2. ç¬¬äºŒæ¬¡ä¸‹è½½ï¼ˆå¤ç”¨çœŸå®ä¸‹è½½å™¨ï¼‰ï¼š");
        downloader.download("https://example.com/file2.zip", "/custom/path/");
        
        System.out.println("\n3. è·å–æ–‡ä»¶å¤§å°ï¼ˆå¸¦ç¼“å­˜ï¼‰ï¼š");
        long size1 = downloader.getFileSize("https://example.com/file3.zip");
        System.out.println("æ–‡ä»¶å¤§å°: " + size1 + " bytes");
        
        // ç¬¬äºŒæ¬¡è·å–ç›¸åŒæ–‡ä»¶å¤§å°ï¼ˆåº”è¯¥ä»ç¼“å­˜è¯»å–ï¼‰
        long size2 = downloader.getFileSize("https://example.com/file3.zip");
        System.out.println("å†æ¬¡è·å–æ–‡ä»¶å¤§å°: " + size2 + " bytes");
        
        System.out.println("\n4. æµ‹è¯•è®¿é—®æ§åˆ¶ï¼š");
        downloader.download("https://example.com/restricted/file.zip");
        
        System.out.println("\n5. ä½¿ç”¨ä»£ç†ç‰¹æœ‰åŠŸèƒ½ï¼š");
        if (downloader instanceof DownloadProxy) {
            DownloadProxy proxy = (DownloadProxy) downloader;
            
            // è·å–ä¸‹è½½ç»Ÿè®¡
            Map<String, Integer> stats = proxy.getDownloadStatistics();
            System.out.println("ä¸‹è½½ç»Ÿè®¡: " + stats);
            
            // æ¸…ç†ç¼“å­˜
            proxy.clearCache();
            
            // å†æ¬¡è·å–æ–‡ä»¶å¤§å°ï¼ˆç¼“å­˜å·²æ¸…ç©ºï¼‰
            downloader.getFileSize("https://example.com/file3.zip");
        }
        
        // 6. å¯¹æ¯”ç›´æ¥ä½¿ç”¨çœŸå®å¯¹è±¡
        System.out.println("\n6. å¯¹æ¯”ç›´æ¥ä½¿ç”¨çœŸå®å¯¹è±¡ï¼š");
        System.out.println("ä½¿ç”¨ä»£ç†ï¼šæœ‰ç¼“å­˜ã€æ—¥å¿—ã€è®¿é—®æ§åˆ¶ç­‰é¢å¤–åŠŸèƒ½");
        System.out.println("ä½¿ç”¨çœŸå®å¯¹è±¡ï¼šåªæœ‰åŸºæœ¬ä¸‹è½½åŠŸèƒ½ï¼Œä½†åˆ›å»ºå¼€é”€å¤§");
    }
}
```





### 2. åŠ¨æ€ä»£ç† - æ•°æ®åº“æ“ä½œæ—¥å¿—

#### 2.1. æ•°æ®åº“æ“ä½œæ¥å£

```java
package cn.probiecoder.proxy;

import java.util.List;

// æ•°æ®åº“æ“ä½œæ¥å£
public interface UserDao {
    void addUser(User user);
    void deleteUser(int id);
    User getUser(int id);
    void updateUser(User user);
    List<User> getAllUsers();
}
```



```java
package cn.probiecoder.proxy;

// ç”¨æˆ·å®ä½“ç±»
public class User {
    private int id;
    private String name;
    private String email;

    public User(int id, String name, String email) {
        this.id = id;
        this.name = name;
        this.email = email;
    }

    // getters and setters
    public int getId() {
        return id;
    }

    public String getName() {
        return name;
    }

    public String getEmail() {
        return email;
    }

    @Override
    public String toString() {
        return "User{id=" + id + ", name='" + name + "', email='" + email + "'}";
    }
}

```



#### 2.2. çœŸå®æ•°æ®åº“æ“ä½œ

```java
package cn.probiecoder.proxy;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

// çœŸå®æ•°æ®åº“æ“ä½œå®ç°
public class UserDaoImpl implements UserDao {
    
    // æ¨¡æ‹Ÿæ•°æ®åº“
    private Map<Integer, User> userDatabase = new HashMap<>();
    private int nextId = 1;
    
    public UserDaoImpl() {
        // åˆå§‹åŒ–ä¸€äº›æµ‹è¯•æ•°æ®
        addUser(new User(nextId++, "å¼ ä¸‰", "zhangsan@example.com"));
        addUser(new User(nextId++, "æå››", "lisi@example.com"));
    }
    
    @Override
    public void addUser(User user) {
        System.out.println("[æ•°æ®åº“] æ·»åŠ ç”¨æˆ·: " + user.getName());
        userDatabase.put(user.getId(), user);
        // æ¨¡æ‹Ÿæ•°æ®åº“æ“ä½œå»¶è¿Ÿ
        simulateDbDelay(200);
    }
    
    @Override
    public void deleteUser(int id) {
        User user = userDatabase.remove(id);
        System.out.println("[æ•°æ®åº“] åˆ é™¤ç”¨æˆ·: " + (user != null ? user.getName() : "ä¸å­˜åœ¨"));
        simulateDbDelay(150);
    }
    
    @Override
    public User getUser(int id) {
        System.out.println("[æ•°æ®åº“] æŸ¥è¯¢ç”¨æˆ· ID=" + id);
        simulateDbDelay(100);
        return userDatabase.get(id);
    }
    
    @Override
    public void updateUser(User user) {
        System.out.println("[æ•°æ®åº“] æ›´æ–°ç”¨æˆ·: " + user.getName());
        userDatabase.put(user.getId(), user);
        simulateDbDelay(250);
    }
    
    @Override
    public List<User> getAllUsers() {
        System.out.println("[æ•°æ®åº“] æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·");
        simulateDbDelay(300);
        return new ArrayList<>(userDatabase.values());
    }
    
    private void simulateDbDelay(int millis) {
        try {
            Thread.sleep(millis);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```



#### 2.3. åŠ¨æ€ä»£ç†å¤„ç†å™¨

```java
package cn.probiecoder.proxy;

import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;
import java.lang.reflect.Proxy;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;

// åŠ¨æ€ä»£ç†å¤„ç†å™¨
public class DaoLoggingHandler implements InvocationHandler {
    private Object target;
    private List<LogEntry> logs = new ArrayList<>();
    
    public DaoLoggingHandler(Object target) {
        this.target = target;
    }
    
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        // è®°å½•æ–¹æ³•è°ƒç”¨å¼€å§‹æ—¶é—´
        long startTime = System.currentTimeMillis();
        LocalDateTime callTime = LocalDateTime.now();
        
        // è®°å½•æ–¹æ³•è°ƒç”¨
        String methodName = method.getName();
        String params = args != null ? Arrays.toString(args) : "[]";
        System.out.println("[åŠ¨æ€ä»£ç†] å¼€å§‹æ‰§è¡Œ: " + methodName + "(" + params + ")");
        
        Object result = null;
        boolean success = true;
        String errorMsg = null;
        
        try {
            // æ‰§è¡ŒçœŸå®æ–¹æ³•
            result = method.invoke(target, args);
            
            // æ–¹æ³•æ‰§è¡Œåçš„å¤„ç†
            if ("getUser".equals(methodName) && result != null) {
                System.out.println("[åŠ¨æ€ä»£ç†] æŸ¥è¯¢åˆ°ç”¨æˆ·: " + result);
            }
            
        } catch (Exception e) {
            success = false;
            errorMsg = e.getCause() != null ? e.getCause().getMessage() : e.getMessage();
            System.out.println("[åŠ¨æ€ä»£ç†] æ‰§è¡Œå¤±è´¥: " + errorMsg);
            throw e;
        } finally {
            // è®¡ç®—æ‰§è¡Œæ—¶é—´
            long endTime = System.currentTimeMillis();
            long duration = endTime - startTime;
            
            // è®°å½•æ—¥å¿—
            LogEntry log = new LogEntry(
                callTime,
                methodName,
                params,
                success,
                duration,
                errorMsg
            );
            logs.add(log);
            
            System.out.println("[åŠ¨æ€ä»£ç†] æ‰§è¡Œå®Œæˆ: " + methodName + 
                             ", è€—æ—¶: " + duration + "ms, æˆåŠŸ: " + success);
        }
        
        return result;
    }
    
    // åˆ›å»ºä»£ç†å¯¹è±¡
    public static <T> T createProxy(T target, Class<T> interfaceClass) {
        DaoLoggingHandler handler = new DaoLoggingHandler(target);
        return (T) Proxy.newProxyInstance(
            interfaceClass.getClassLoader(),
            new Class[]{interfaceClass},
            handler
        );
    }
    
    // è·å–æ—¥å¿—
    public List<LogEntry> getLogs() {
        return new ArrayList<>(logs);
    }
    
    public void clearLogs() {
        logs.clear();
    }
    
    // æ—¥å¿—æ¡ç›®ç±»
    public static class LogEntry {
        private LocalDateTime timestamp;
        private String methodName;
        private String parameters;
        private boolean success;
        private long duration;
        private String errorMessage;
        
        public LogEntry(LocalDateTime timestamp, String methodName, String parameters, 
                       boolean success, long duration, String errorMessage) {
            this.timestamp = timestamp;
            this.methodName = methodName;
            this.parameters = parameters;
            this.success = success;
            this.duration = duration;
            this.errorMessage = errorMessage;
        }
        
        @Override
        public String toString() {
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss.SSS");
            return String.format("[%s] %s(%s) - æˆåŠŸ: %s, è€—æ—¶: %dms, é”™è¯¯: %s",
                timestamp.format(formatter),
                methodName,
                parameters,
                success,
                duration,
                errorMessage != null ? errorMessage : "æ— "
            );
        }
    }
}
```



#### 2.4. å®¢æˆ·ç«¯ä½¿ç”¨åŠ¨æ€ä»£ç†

```java
package cn.probiecoder.proxy;

import java.lang.reflect.Proxy;
import java.util.Arrays;
import java.util.List;

// å®¢æˆ·ç«¯ä½¿ç”¨åŠ¨æ€ä»£ç†
public class DynamicProxyClient {
    public static void main(String[] args) {
        System.out.println("=== åŠ¨æ€ä»£ç†æ¨¡å¼ - æ•°æ®åº“æ“ä½œæ—¥å¿— ===\n");
        
        // 1. åˆ›å»ºçœŸå®å¯¹è±¡
        UserDao realDao = new UserDaoImpl();
        
        // 2. åˆ›å»ºåŠ¨æ€ä»£ç†
        UserDao proxyDao = DaoLoggingHandler.createProxy(realDao, UserDao.class);
        
        // 3. ä½¿ç”¨ä»£ç†æ‰§è¡Œæ“ä½œ
        System.out.println("1. æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼š");
        
        // æ·»åŠ ç”¨æˆ·
        System.out.println("\næ·»åŠ æ–°ç”¨æˆ·ï¼š");
        proxyDao.addUser(new User(100, "ç‹äº”", "wangwu@example.com"));
        
        // æŸ¥è¯¢ç”¨æˆ·
        System.out.println("\næŸ¥è¯¢ç”¨æˆ·ï¼š");
        User user = proxyDao.getUser(2);
        System.out.println("æŸ¥è¯¢ç»“æœ: " + user);
        
        // æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
        System.out.println("\næŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ï¼š");
        List<User> allUsers = proxyDao.getAllUsers();
        System.out.println("æ‰€æœ‰ç”¨æˆ·: " + allUsers);
        
        // æ›´æ–°ç”¨æˆ·
        System.out.println("\næ›´æ–°ç”¨æˆ·ï¼š");
        proxyDao.updateUser(new User(1, "å¼ ä¸‰ï¼ˆæ›´æ–°ï¼‰", "zhangsan_updated@example.com"));
        
        // åˆ é™¤ç”¨æˆ·
        System.out.println("\nåˆ é™¤ç”¨æˆ·ï¼š");
        proxyDao.deleteUser(2);
        
        // 4. æŸ¥çœ‹æ“ä½œæ—¥å¿—
        System.out.println("\n2. æŸ¥çœ‹æ“ä½œæ—¥å¿—ï¼š");
        
        // è·å–å¤„ç†å™¨ä»¥è®¿é—®æ—¥å¿—
        DaoLoggingHandler handler = getHandlerFromProxy(proxyDao);
        if (handler != null) {
            List<DaoLoggingHandler.LogEntry> logs = handler.getLogs();
            System.out.println("=== æ“ä½œæ—¥å¿— ===");
            for (DaoLoggingHandler.LogEntry log : logs) {
                System.out.println(log);
            }
            
            
            System.out.println("æ€»æ“ä½œæ•°: " + logs.size());
        }
        
        // 5. ä»£ç†å¯¹è±¡ä¿¡æ¯
        System.out.println("\n3. ä»£ç†å¯¹è±¡ä¿¡æ¯ï¼š");
        System.out.println("ä»£ç†ç±»: " + proxyDao.getClass().getName());
        System.out.println("ä»£ç†ç±»çš„çˆ¶ç±»: " + proxyDao.getClass().getSuperclass().getName());
        System.out.println("ä»£ç†ç±»å®ç°çš„æ¥å£: " + Arrays.toString(proxyDao.getClass().getInterfaces()));
        
        // 6. æ€§èƒ½ç›‘æ§ç¤ºä¾‹
        System.out.println("\n4. æ€§èƒ½ç›‘æ§ç¤ºä¾‹ï¼š");
        monitorPerformance(proxyDao);
    }
    
    private static DaoLoggingHandler getHandlerFromProxy(Object proxy) {
        try {
            // é€šè¿‡åå°„è·å–InvocationHandler
            if (Proxy.isProxyClass(proxy.getClass())) {
                return (DaoLoggingHandler) Proxy.getInvocationHandler(proxy);
            }
        } catch (Exception e) {
            System.out.println("æ— æ³•è·å–å¤„ç†å™¨: " + e.getMessage());
        }
        return null;
    }
    
    private static void monitorPerformance(UserDao dao) {
        System.out.println("å¼€å§‹æ€§èƒ½ç›‘æ§æµ‹è¯•...");
        
        long startTime = System.currentTimeMillis();
        
        // æ‰§è¡Œæ‰¹é‡æ“ä½œ
        for (int i = 0; i < 5; i++) {
            dao.getUser(1);
        }
        
        long endTime = System.currentTimeMillis();
        System.out.println("æ‰¹é‡æŸ¥è¯¢5æ¬¡è€—æ—¶: " + (endTime - startTime) + "ms");
    }
}
```

